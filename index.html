import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged 
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    onSnapshot, 
    updateDoc, 
    arrayUnion,
    setLogLevel
} from 'firebase/firestore';

// --- Global Firebase Configuration Variables (MANDATORY USE) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
// -------------------------------------------------------------

// Base initial state (financials only). Card details are added upon setup.
const baseAccountData = {
    checkingBalance: 0.00,
    savingsBalance: 0.00,
    transactions: [], 
    loanBalance: 0.00, 
    // NEW STATE: Card frozen status
    isCardFrozen: false, 
    cardHolderName: null, 
    cardNumber: null,
    cardExpiry: null,
    cardCVV: null
};

// Utility to format currency
const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
    }).format(amount);
};

// SVG Icon definitions for the mobile navigation (using lucide-react style inline SVGs)
const Icons = {
    Overview: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    Transfer: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 1 21 5 17 9"/><line x1="3" y1="5" x2="21" y2="5"/><polyline points="7 23 3 19 7 15"/><line x1="21" y1="19" x2="3" y2="19"/></svg>,
    Deposit: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    Withdraw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    Loan: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 010 7H15a3.5 3.5 0 010 7H6"/></svg>,
    History: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/><polyline points="12 8 12 12 14 14"/></svg>,
    Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
    Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 8.84-2.71"/></svg>,
    Card: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>,
    Support: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
    Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
};

// Define the tabs for navigation
const TABS = [
    { id: 'summary', name: 'Overview', icon: Icons.Overview },
    { id: 'transfer', name: 'Transfer', icon: Icons.Transfer },
    { id: 'deposit', name: 'Deposit', icon: Icons.Deposit },
    { id: 'withdraw', name: 'Withdraw', icon: Icons.Withdraw },
    { id: 'loan', name: 'Loan', icon: Icons.Loan },
    { id: 'history', name: 'History', icon: Icons.History },
];

// Custom Hook to manage Firebase setup and state
const useFirebaseAndData = () => {
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [accountData, setAccountData] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // 1. Initialize Firebase, Auth, and Firestore
    useEffect(() => {
        if (!firebaseConfig) {
            setError("Firebase configuration is missing.");
            setLoading(false);
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);
            setLogLevel('debug');

            setDb(dbInstance);

            const setupAuth = async (auth) => {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            };

            const unsubscribeAuth = onAuthStateChanged(authInstance, (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    setupAuth(authInstance);
                }
                setIsAuthReady(true);
                setLoading(false); 
            });

            return () => unsubscribeAuth();

        } catch (err) {
            console.error("Firebase initialization failed:", err);
            setError("Failed to initialize the application.");
            setLoading(false);
        }
    }, [firebaseConfig, initialAuthToken]);

    // 3. Real-time Firestore Listener
    useEffect(() => {
        if (!db || !userId) return;

        const docRef = doc(db, 
            `artifacts/${appId}/users/${userId}/adam_corp_accounts/main_account`
        );
        
        const unsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                // Ensure new fields are present if old document structure is loaded
                const data = docSnap.data();
                setAccountData({
                    ...baseAccountData,
                    ...data,
                    // Ensure the new isCardFrozen state defaults properly if missing
                    isCardFrozen: data.isCardFrozen === undefined ? false : data.isCardFrozen,
                });
            } else {
                // If document does not exist, initialize it with base data (card details null)
                console.log("Account document missing. Initializing base account...");
                setDoc(docRef, baseAccountData)
                    .then(() => setAccountData(baseAccountData))
                    .catch(e => {
                        console.error("Error setting initial document:", e);
                        setError("Could not set initial account data.");
                    });
            }
        }, (err) => {
            console.error("Firestore snapshot error:", err);
            setError("Failed to fetch real-time data from Firestore.");
        });

        return () => unsubscribe();
    }, [db, userId]);

    return { db, userId, accountData, loading, error, isAuthReady };
};

// Reusable Card Component
const DashboardCard = ({ title, children, className = '' }) => (
    <div className={`p-5 bg-white rounded-xl shadow-xl border border-gray-100 transition duration-300 hover:shadow-2xl ${className}`}>
        <h2 className="text-xl font-semibold text-green-800 mb-4 border-b border-gray-200 pb-2">{title}</h2>
        {children}
    </div>
);

// --- Virtual Card (UPDATED with Placeholders and Freeze Overlay) ---
const VirtualCard = ({ cardHolderName, cardNumber, cardExpiry, isCardFrozen }) => {
    // Uses the stored clean number but formats it for display
    const formattedCardNumber = cardNumber ? 
        cardNumber.match(/.{1,4}/g)?.join(' ') : 'XXXX XXXX XXXX XXXX';
    
    // Conditional styling for when the card is frozen
    const cardClass = isCardFrozen ? 'grayscale opacity-75' : '';

    return (
        <div className="w-full aspect-[1.586/1] max-w-sm mx-auto rounded-xl shadow-2xl overflow-hidden relative transform transition-transform duration-500 hover:scale-[1.02] cursor-pointer">
            
            {/* Frozen Overlay */}
            {isCardFrozen && (
                <div className="absolute inset-0 bg-red-800 bg-opacity-80 z-10 flex flex-col items-center justify-center p-4">
                    <Icons.Lock />
                    <p className="text-white text-3xl font-extrabold tracking-widest mt-2">FROZEN</p>
                    <p className="text-red-200 text-sm mt-1 text-center">All transactions are blocked until unfrozen.</p>
                </div>
            )}

            {/* Card Content */}
            <div className={`p-5 bg-gradient-to-br from-green-700 to-emerald-600 text-white h-full ${cardClass}`}>
                
                {/* Row 1: App Name & Chip Placeholder */}
                <div className="flex justify-between items-start mb-4">
                    <span className="font-mono text-lg font-bold">ADAM CORP.</span>
                    <img 
                        src="https://placehold.co/40x30/C0C0C0/333333?text=CHIP" 
                        alt="Digital Card Chip Placeholder"
                        className="rounded"
                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/40x30/C0C0C0/333333?text=CHIP" }}
                    />
                </div>
                
                {/* Card Number */}
                <p className="font-mono text-xl tracking-widest mb-6 mt-12">
                    {formattedCardNumber}
                </p>

                {/* Row 3: Name, Expiry, and Network Logo Placeholder */}
                <div className="flex justify-between items-end">
                    <div>
                        <p className="text-xs opacity-75">Card Holder</p>
                        <p className="text-sm font-semibold uppercase tracking-wider">{cardHolderName || 'User Name'}</p>
                    </div>
                    <div className="text-right">
                        <p className="text-xs opacity-75">Expires</p>
                        <p className="text-sm font-semibold mb-1">{cardExpiry || 'MM/YY'}</p>
                    </div>
                    <img 
                        src="https://placehold.co/60x40/FF7F00/FFFFFF?text=NETWORK" 
                        alt="Payment Network Logo Placeholder"
                        className="h-6 w-auto"
                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/60x40/FF7F00/FFFFFF?text=NETWORK" }}
                    />
                </div>
            </div>
        </div>
    );
};
// ------------------------------------

// --- NEW Action Buttons Component ---
const ActionButtons = ({ db, userId, isCardFrozen }) => {
    const docRef = doc(db, `artifacts/${appId}/users/${userId}/adam_corp_accounts/main_account`);
    const [message, setMessage] = useState('');

    const toggleFreeze = async () => {
        setMessage('');
        try {
            await updateDoc(docRef, { isCardFrozen: !isCardFrozen });
            const status = isCardFrozen ? 'Unfrozen' : 'Frozen';
            setMessage(`Card successfully ${status}.`);
        } catch (e) {
            setMessage('Failed to update card status.');
            console.error("Freeze toggle failed:", e);
        }
        setTimeout(() => setMessage(''), 3000);
    };

    const handleAction = (actionName) => {
        setMessage('');
        setMessage(`${actionName} request submitted successfully.`);
        setTimeout(() => setMessage(''), 3000);
    };

    return (
        <DashboardCard title="Quick Actions">
            {message && (
                <div className={`p-3 rounded-lg text-sm font-medium mb-3 ${message.includes('successfully') ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100'}`}>
                    {message}
                </div>
            )}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                
                {/* 1. Freeze Card Button */}
                <button
                    onClick={toggleFreeze}
                    className={`flex flex-col items-center justify-center p-3 rounded-xl transition duration-150 text-sm font-medium shadow-md 
                        ${isCardFrozen ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-red-500 text-white hover:bg-red-600'}
                    `}
                >
                    {isCardFrozen ? <Icons.Unlock /> : <Icons.Lock />}
                    <span className="mt-1">{isCardFrozen ? 'Unfreeze Card' : 'Freeze Card'}</span>
                </button>

                {/* 2. Order New Physical Card Button */}
                <button
                    onClick={() => handleAction('New physical card order')}
                    className="flex flex-col items-center justify-center p-3 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-150 text-sm font-medium shadow-md"
                >
                    <Icons.Card />
                    <span className="mt-1">Order New Card</span>
                </button>

                {/* 3. Contact Support Button */}
                <button
                    onClick={() => handleAction('Adam Support contact')}
                    className="flex flex-col items-center justify-center p-3 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-150 text-sm font-medium shadow-md"
                >
                    <Icons.Support />
                    <span className="mt-1">Contact Support</span>
                </button>

                {/* 4. Make a New Account Button */}
                <button
                    onClick={() => handleAction('New Account creation')}
                    className="flex flex-col items-center justify-center p-3 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 transition duration-150 text-sm font-medium shadow-md"
                >
                    <Icons.Plus />
                    <span className="mt-1">New Account</span>
                </button>
            </div>
        </DashboardCard>
    );
};
// ------------------------------------


// Account Summary Component (Updated to pass isCardFrozen to VirtualCard)
const AccountSummary = ({ accountData, userId }) => (
    <div className="space-y-6 w-full">
        <VirtualCard 
            cardHolderName={accountData.cardHolderName}
            cardNumber={accountData.cardNumber}
            cardExpiry={accountData.cardExpiry}
            isCardFrozen={accountData.isCardFrozen}
        />
        <DashboardCard title="Account Balances" className="w-full">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div className="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                    <p className="text-sm text-green-700 font-medium">Checking Balance</p>
                    <p className="text-2xl font-extrabold text-green-800 mt-1">
                        {formatCurrency(accountData.checkingBalance)}
                    </p>
                </div>
                <div className="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                    <p className="text-sm text-green-700 font-medium">Savings Balance</p>
                    <p className="text-2xl font-extrabold text-green-800 mt-1">
                        {formatCurrency(accountData.savingsBalance)}
                    </p>
                </div>
                
                {/* Outstanding Loan Display */}
                <div className="p-4 bg-red-50 rounded-lg border border-red-200 md:col-span-2 lg:col-span-1">
                    <p className="text-sm text-red-700 font-medium">Outstanding Loan Balance</p>
                    <p className="text-2xl font-extrabold text-red-800 mt-1">
                        {/* Display as a negative number */}
                        {formatCurrency(accountData.loanBalance * -1)}
                    </p>
                </div>
            </div>
            <div className="mt-4 text-xs text-gray-500 overflow-hidden truncate">
                <span className="font-semibold">User ID:</span> {userId}
            </div>
        </DashboardCard>
    </div>
);

// Transaction Form Base Component 
const TransactionForm = ({ title, buttonText, onSubmit, children }) => {
    const [amount, setAmount] = useState('');
    const [source, setSource] = useState('checking'); 
    const [destination, setDestination] = useState('savings'); 
    const [message, setMessage] = useState('');
    const [messageType, setMessageType] = useState(''); 

    const handleSubmit = async (e) => {
        e.preventDefault();
        setMessage('');
        try {
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount) || numAmount <= 0) {
                throw new Error("Please enter a valid amount greater than $0.00.");
            }

            // onSubmit is now passed the full event and form state
            await onSubmit({ numAmount, source, destination }); 
            setMessage(`${title} successful! Amount: ${formatCurrency(numAmount)}`);
            setMessageType('success');
            setAmount('');
        } catch (error) {
            console.error(`${title} failed:`, error);
            setMessage(`Error: ${error.message}`);
            setMessageType('error');
        }
    };

    const messageStyle = messageType === 'success' ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';

    return (
        <DashboardCard title={title}>
            <form onSubmit={handleSubmit} className="space-y-4">
                <div className="space-y-2">
                    {children({ amount, setAmount, source, setSource, destination, setDestination })}
                </div>
                {message && (
                    <div className={`p-3 rounded-lg text-sm font-medium ${messageStyle}`}>
                        {message}
                    </div>
                )}
                <button
                    type="submit"
                    // Updated Button styling
                    className="w-full bg-green-600 text-white py-2 rounded-lg font-bold transition duration-200 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 shadow-md"
                >
                    {buttonText}
                </button>
            </form>
        </DashboardCard>
    );
};

// --- Loan Module Component ---
const LoanFunds = ({ db, userId, accountData }) => {
    const docRef = doc(db, `artifacts/${appId}/users/${userId}/adam_corp_accounts/main_account`);

    const takeLoan = async ({ numAmount }) => {
        // Prevent taking a loan if one is already outstanding
        if (accountData.loanBalance > 0.00) {
            throw new Error(`You must repay your current loan balance of ${formatCurrency(accountData.loanBalance)} before requesting a new loan.`);
        }
        
        // Simple minimum amount check
        if (numAmount < 100) {
            throw new Error("Minimum loan principal amount is $100.00.");
        }
        
        const newCheckingBalance = accountData.checkingBalance + numAmount;
        const newLoanBalance = accountData.loanBalance + numAmount; 

        const timestamp = new Date().toISOString();

        const loanCreditTransaction = {
            id: crypto.randomUUID(),
            date: timestamp,
            description: 'Loan Disbursement (Principal)',
            amount: numAmount,
            type: 'Credit',
            account: 'checking' // Loan funds go directly to checking
        };
        
        await updateDoc(docRef, {
            checkingBalance: parseFloat(newCheckingBalance.toFixed(2)),
            loanBalance: parseFloat(newLoanBalance.toFixed(2)),
            transactions: arrayUnion(loanCreditTransaction)
        });
    };

    return (
        <TransactionForm 
            title="Request a Loan" 
            buttonText="Disburse Loan to Checking" 
            onSubmit={({ numAmount }) => takeLoan({ numAmount })} // Only pass amount needed for loan
        >
            {({ amount, setAmount }) => (
                <>
                    <label className="block">
                        <span className="text-gray-700">Principal Amount (Min $100)</span>
                        <input 
                            type="number" 
                            step="1.00" 
                            min="100.00"
                            value={amount} 
                            onChange={(e) => setAmount(e.target.value)} 
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                            placeholder="e.g., 5000.00"
                            required
                            disabled={accountData.loanBalance > 0.00}
                        />
                    </label>
                    {accountData.loanBalance > 0.00 && (
                        <div className="p-3 bg-red-100 text-red-700 text-sm rounded-lg font-medium">
                            Current Outstanding Loan: {formatCurrency(accountData.loanBalance)}. Please repay it before requesting another loan.
                        </div>
                    )}
                    <div className="text-xs text-gray-500 mt-2">
                        The principal amount will be deposited into your Checking account.
                    </div>
                </>
            )}
        </TransactionForm>
    );
};
// --------------------------------------------------


// Transfer Module Component (Logic remains the same)
const TransferFunds = ({ db, userId, accountData }) => {
    const docRef = doc(db, `artifacts/${appId}/users/${userId}/adam_corp_accounts/main_account`);

    const transfer = async ({ numAmount, source, destination }) => {
        const sourceAccountKey = source + 'Balance'; 
        const destAccountKey = destination + 'Balance'; 
        const currentBalance = accountData[sourceAccountKey];

        if (numAmount > currentBalance) {
            throw new Error(`Insufficient funds in your ${source} account. Max transfer: ${formatCurrency(currentBalance)}`);
        }
        if (source === destination) {
            throw new Error("Source and destination accounts must be different for a transfer.");
        }

        const newSourceBalance = currentBalance - numAmount;
        const newDestBalance = accountData[destAccountKey] + numAmount;

        const timestamp = new Date().toISOString();
        
        const debitTransaction = { 
            id: crypto.randomUUID(), 
            date: timestamp, 
            description: `Transfer to ${destination} account`, 
            amount: numAmount, 
            type: 'Debit', 
            account: source 
        };
        const creditTransaction = { 
            id: crypto.randomUUID(), 
            date: timestamp, 
            description: `Transfer from ${source} account`, 
            amount: numAmount, 
            type: 'Credit', 
            account: destination 
        };

        await updateDoc(docRef, {
            [sourceAccountKey]: parseFloat(newSourceBalance.toFixed(2)),
            [destAccountKey]: parseFloat(newDestBalance.toFixed(2)),
            transactions: arrayUnion(debitTransaction, creditTransaction)
        });
    };

    return (
        <TransactionForm 
            title="Transfer Funds" 
            buttonText="Execute Transfer" 
            onSubmit={transfer}
        >
            {({ amount, setAmount, source, setSource, destination, setDestination }) => (
                <>
                    <label className="block">
                        <span className="text-gray-700">Amount to Transfer</span>
                        <input 
                            type="number" 
                            step="0.01" 
                            min="0.01"
                            value={amount} 
                            onChange={(e) => setAmount(e.target.value)} 
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                            placeholder="e.g., 500.00"
                            required
                        />
                    </label>
                    <label className="block">
                        <span className="text-gray-700">From Account (Source)</span>
                        <select 
                            value={source} 
                            onChange={(e) => {
                                setSource(e.target.value);
                                setDestination(e.target.value === 'checking' ? 'savings' : 'checking');
                            }}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 bg-white"
                        >
                            <option value="checking">Checking ({formatCurrency(accountData.checkingBalance)})</option>
                            <option value="savings">Savings ({formatCurrency(accountData.savingsBalance)})</option>
                        </select>
                    </label>
                    <label className="block">
                        <span className="text-gray-700">To Account (Destination)</span>
                        <select 
                            value={destination} 
                            onChange={(e) => {
                                setDestination(e.target.value);
                                setSource(e.target.value === 'checking' ? 'savings' : 'checking');
                            }}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 bg-white"
                        >
                            <option value={source === 'checking' ? 'savings' : 'checking'}>
                                {source === 'checking' ? 'Savings' : 'Checking'}
                            </option>
                        </select>
                    </label>
                </>
            )}
        </TransactionForm>
    );
};

// Deposit Module Component (Logic remains the same)
const DepositFunds = ({ db, userId, accountData }) => {
    const docRef = doc(db, `artifacts/${appId}/users/${userId}/adam_corp_accounts/main_account`);

    const deposit = async ({ numAmount, destination }) => {
        const destAccountKey = destination + 'Balance';
        const currentBalance = accountData[destAccountKey];

        const newBalance = currentBalance + numAmount;
        const timestamp = new Date().toISOString();

        const depositTransaction = {
            id: crypto.randomUUID(),
            date: timestamp,
            description: 'Direct Deposit',
            amount: numAmount,
            type: 'Credit',
            account: destination
        };

        await updateDoc(docRef, {
            [destAccountKey]: parseFloat(newBalance.toFixed(2)),
            transactions: arrayUnion(depositTransaction)
        });
    };

    return (
        <TransactionForm 
            title="Deposit Funds" 
            buttonText="Confirm Deposit" 
            onSubmit={deposit}
        >
            {({ amount, setAmount, destination, setDestination }) => (
                <>
                    <label className="block">
                        <span className="text-gray-700">Amount to Deposit</span>
                        <input 
                            type="number" 
                            step="0.01" 
                            min="0.01"
                            value={amount} 
                            onChange={(e) => setAmount(e.target.value)} 
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                            placeholder="e.g., 1000.00"
                            required
                        />
                    </label>
                    <label className="block">
                        <span className="text-gray-700">Destination Account</span>
                        <select 
                            value={destination} 
                            onChange={(e) => setDestination(e.target.value)}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 bg-white"
                        >
                            <option value="checking">Checking ({formatCurrency(accountData.checkingBalance)})</option>
                            <option value="savings">Savings ({formatCurrency(accountData.savingsBalance)})</option>
                        </select>
                    </label>
                </>
            )}
        </TransactionForm>
    );
};

// Withdrawal Module Component (Logic remains the same)
const WithdrawalFunds = ({ db, userId, accountData }) => {
    const docRef = doc(db, `artifacts/${appId}/users/${userId}/adam_corp_accounts/main_account`);

    const withdraw = async ({ numAmount, source }) => {
        const sourceAccountKey = source + 'Balance';
        const currentBalance = accountData[sourceAccountKey];

        // Critical Validation: Prevent Overdraft
        if (numAmount > currentBalance) {
            throw new Error(`Overdraft prevented. You can only withdraw up to ${formatCurrency(currentBalance)} from your ${source} account.`);
        }

        const newBalance = currentBalance - numAmount;
        const timestamp = new Date().toISOString();

        const withdrawalTransaction = {
            id: crypto.randomUUID(),
            date: timestamp,
            description: 'ATM Withdrawal',
            amount: numAmount,
            type: 'Debit',
            account: source
        };

        await updateDoc(docRef, {
            [sourceAccountKey]: parseFloat(newBalance.toFixed(2)),
            transactions: arrayUnion(withdrawalTransaction)
        });
    };

    return (
        <TransactionForm 
            title="Withdraw Funds" 
            buttonText="Confirm Withdrawal" 
            onSubmit={withdraw}
        >
            {({ amount, setAmount, source, setSource }) => (
                <>
                    <label className="block">
                        <span className="text-gray-700">Amount to Withdraw</span>
                        <input 
                            type="number" 
                            step="0.01" 
                            min="0.01"
                            value={amount} 
                            onChange={(e) => setAmount(e.target.value)} 
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                            placeholder="e.g., 200.00"
                            required
                        />
                    </label>
                    <label className="block">
                        <span className="text-gray-700">Source Account</span>
                        <select 
                            value={source} 
                            onChange={(e) => setSource(e.target.value)}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 bg-white"
                        >
                            <option value="checking">Checking ({formatCurrency(accountData.checkingBalance)})</option>
                            <option value="savings">Savings ({formatCurrency(accountData.savingsBalance)})</option>
                        </select>
                    </label>
                </>
            )}
        </TransactionForm>
    );
};

// Transaction History Component (Unchanged)
const TransactionHistory = ({ transactions, limit = 5 }) => {
    const displayTransactions = useMemo(() => {
        if (!transactions) return [];
        return [...transactions]
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, limit);
    }, [transactions, limit]);

    return (
        <div className="w-full">
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-emerald-50">
                        <tr>
                            <th className="px-3 py-2 text-left text-xs font-medium text-green-800 uppercase tracking-wider rounded-tl-lg">Date</th>
                            <th className="px-3 py-2 text-left text-xs font-medium text-green-800 uppercase tracking-wider">Description</th>
                            <th className="px-3 py-2 text-center text-xs font-medium text-green-800 uppercase tracking-wider hidden sm:table-cell">Account</th>
                            <th className="px-3 py-2 text-right text-xs font-medium text-green-800 uppercase tracking-wider">Amount</th>
                            <th className="px-3 py-2 text-center text-xs font-medium text-green-800 uppercase tracking-wider rounded-tr-lg hidden sm:table-cell">Type</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-100">
                        {displayTransactions.length === 0 ? (
                            <tr>
                                <td colSpan="5" className="px-3 py-4 text-sm text-gray-500 text-center italic">No transactions recorded yet.</td>
                            </tr>
                        ) : (
                            displayTransactions.map((tx) => {
                                const isCredit = tx.type === 'Credit';
                                const amountClass = isCredit ? 'text-green-600' : 'text-red-600';
                                const typeClass = isCredit ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                                return (
                                    <tr key={tx.id} className="hover:bg-gray-50">
                                        <td className="px-3 py-3 whitespace-nowrap text-xs text-gray-500">
                                            {new Date(tx.date).toLocaleDateString()}
                                        </td>
                                        <td className="px-3 py-3 text-sm text-gray-900 truncate max-w-xs">{tx.description}</td>
                                        <td className="px-3 py-3 whitespace-nowrap text-center text-sm font-medium text-green-600 capitalize hidden sm:table-cell">
                                            {tx.account || 'N/A'}
                                        </td>
                                        <td className={`px-3 py-3 whitespace-nowrap text-sm text-right font-semibold ${amountClass}`}>
                                            {isCredit ? '+' : '-'}{formatCurrency(tx.amount)}
                                        </td>
                                        <td className="px-3 py-3 whitespace-nowrap text-center hidden sm:table-cell">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeClass}`}>
                                                {tx.type}
                                            </span>
                                        </td>
                                    </tr>
                                );
                            })
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

// --- Card Setup/Sign-up Screen (Unchanged) ---
const CardSetupForm = ({ db, userId }) => {
    const [cardHolderName, setCardHolderName] = useState('');
    const [cardNumberInput, setCardNumberInput] = useState('');
    const [cardExpiryInput, setCardExpiryInput] = useState('');
    const [cardCVVInput, setCardCVVInput] = useState('');
    
    const [message, setMessage] = useState('');
    const [loading, setLoading] = useState(false);

    // Input Formatting Handlers
    const handleCardNumberChange = (e) => {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        value = value.substring(0, 16); // Limit to 16 digits
        
        // Format into groups of four (e.g., 1234 5678 9012 3456)
        const formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        setCardNumberInput(formattedValue);
    };
    
    const handleCardExpiryChange = (e) => {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        value = value.substring(0, 4); // Limit to MMYY
        
        // Format MM/YY
        if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        }
        
        setCardExpiryInput(value);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setMessage('');
        setLoading(true);

        const cleanNumber = cardNumberInput.replace(/\s/g, '');
        const cleanExpiry = cardExpiryInput.replace('/', '');

        try {
            if (!cardHolderName.trim() || cardHolderName.trim().split(' ').length < 2) {
                throw new Error("Please enter your full name (first and last).");
            }
            if (cleanNumber.length !== 16) {
                throw new Error("Card number must be 16 digits.");
            }
            if (cleanExpiry.length !== 4) {
                throw new Error("Expiry date must be in MM/YY format.");
            }
            const month = parseInt(cleanExpiry.substring(0, 2));
            
            // Check for valid month (1-12)
            if (month === 0 || month > 12) {
                throw new Error("Invalid month in expiry date.");
            }
            if (cardCVVInput.length !== 3) {
                throw new Error("CVV must be 3 digits.");
            }

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/adam_corp_accounts/main_account`);

            const setupData = {
                cardHolderName: cardHolderName.toUpperCase().trim(),
                cardNumber: cleanNumber, // Store clean number for data integrity
                cardExpiry: cardExpiryInput, // Store formatted expiry for display
                cardCVV: cardCVVInput 
            };

            await updateDoc(docRef, setupData);

            setMessage("Setup complete! Redirecting to dashboard...");
        } catch (error) {
            console.error("Card setup failed:", error);
            setMessage(`Setup failed: ${error.message}`);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-green-800 p-4 font-sans">
            <div className="w-full max-w-md p-6 bg-white rounded-xl shadow-2xl">
                <h2 className="text-3xl font-extrabold text-green-800 mb-2">Welcome to Adam Corp.</h2>
                <p className="text-gray-600 mb-6">Enter your virtual card details below to activate your account dashboard.</p>
                
                <form onSubmit={handleSubmit} className="space-y-4">
                    <label className="block">
                        <span className="text-gray-700 font-medium">Card Holder Full Name</span>
                        <input 
                            type="text" 
                            value={cardHolderName} 
                            onChange={(e) => setCardHolderName(e.target.value)} 
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                            placeholder="e.g., Jane Doe"
                            required
                        />
                    </label>

                    <label className="block">
                        <span className="text-gray-700 font-medium">Card Number (16 Digits)</span>
                        <input 
                            type="tel" // Use tel for mobile number pad
                            inputMode="numeric"
                            value={cardNumberInput} 
                            onChange={handleCardNumberChange} 
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 font-mono text-lg tracking-wider focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                            placeholder="0000 0000 0000 0000"
                            maxLength="19" // 16 digits + 3 spaces
                            required
                        />
                    </label>

                    <div className="flex space-x-4">
                        <label className="block w-1/2">
                            <span className="text-gray-700 font-medium">Expiry (MM/YY)</span>
                            <input 
                                type="tel"
                                inputMode="numeric"
                                value={cardExpiryInput} 
                                onChange={handleCardExpiryChange} 
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 font-mono focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                                placeholder="MM/YY"
                                maxLength="5" // MM/YY
                                required
                            />
                        </label>
                        <label className="block w-1/2">
                            <span className="text-gray-700 font-medium">CVV (3 Digits)</span>
                            <input 
                                type="password" 
                                inputMode="numeric"
                                value={cardCVVInput} 
                                onChange={(e) => {
                                    const value = e.target.value.replace(/\D/g, '');
                                    setCardCVVInput(value.substring(0, 3));
                                }} 
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 font-mono focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                                placeholder="123"
                                maxLength="3"
                                required
                            />
                        </label>
                    </div>

                    {message && (
                        <div className={`p-3 rounded-lg text-sm font-medium ${message.includes('complete') ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100'}`}>
                            {message}
                        </div>
                    )}

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-green-600 text-white py-3 rounded-lg font-bold transition duration-200 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 shadow-md disabled:opacity-50"
                    >
                        {loading ? 'Activating Card...' : 'Activate Card & Continue'}
                    </button>
                </form>
            </div>
        </div>
    );
};
// --------------------------------------------------


// Main App Component
export default function App() {
    const { db, userId, accountData, loading, error, isAuthReady } = useFirebaseAndData();
    const [activeTab, setActiveTab] = useState('summary'); 

    if (error) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                <div className="p-6 rounded-xl bg-white shadow-xl max-w-md w-full text-center">
                    <p className="text-red-600 font-bold mb-3">Application Error</p>
                    <p className="text-gray-700">{error}</p>
                </div>
            </div>
        );
    }

    if (loading || !isAuthReady || !accountData) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="flex items-center space-x-2 text-green-700">
                    <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Loading Adam Corp Dashboard...</span>
                </div>
            </div>
        );
    }

    // --- Conditional Check for Setup Completion ---
    const isSetupComplete = accountData.cardHolderName !== null;
    
    if (!isSetupComplete) {
        return <CardSetupForm db={db} userId={userId} />;
    }
    // ---------------------------------------------

    const commonProps = { db, userId, accountData };

    // Function to render the active module content for mobile
    const renderMobileContent = () => {
        switch (activeTab) {
            case 'summary':
                return (
                    <div className="space-y-6">
                        <AccountSummary 
                            accountData={accountData}
                            userId={userId}
                        />
                        <ActionButtons 
                            db={db}
                            userId={userId}
                            isCardFrozen={accountData.isCardFrozen}
                        />
                         {/* History Preview */}
                        <DashboardCard title="Latest Transactions (Preview)">
                             <TransactionHistory transactions={accountData.transactions} limit={3} /> 
                             <button onClick={() => setActiveTab('history')} className="mt-4 w-full text-center text-sm text-green-700 font-medium hover:text-green-900">
                                View Full History
                            </button>
                        </DashboardCard>
                    </div>
                );
            case 'transfer':
                return <TransferFunds {...commonProps} />;
            case 'deposit':
                return <DepositFunds {...commonProps} />;
            case 'withdraw':
                return <WithdrawalFunds {...commonProps} />;
            case 'loan': // NEW Mobile Loan Tab
                return <LoanFunds {...commonProps} />;
            case 'history':
                return (
                    <DashboardCard title="Full Transaction History">
                        <TransactionHistory transactions={accountData.transactions} limit={15} /> 
                    </DashboardCard>
                );
            default:
                return null;
        }
    };

    return (
        <div className="min-h-screen bg-gray-50 font-sans">
            
            {/* Header: Fixed top bar for all screens */}
            <header className="p-4 bg-green-800 text-white shadow-xl fixed w-full top-0 left-0 z-10 lg:static flex justify-between items-center">
                
                {/* Logo Placeholder */}
                <img 
                    src="https://placehold.co/120x30/FFFFFF/065F46?text=ADAM+CORP+LOGO" 
                    alt="Adam Corp Logo Placeholder"
                    className="h-8 w-auto"
                    onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/120x30/FFFFFF/065F46?text=ADAM+CORP+LOGO" }}
                />

                {/* Original App Title (as fallback/secondary title) */}
                <h1 className="text-xl lg:text-3xl font-bold tracking-tight text-green-200">
                    ADAM CORP.
                </h1>
            </header>

            {/* Mobile Main Content Area (Hidden on large screens) */}
            <main className="lg:hidden pt-20 pb-16 p-4"> {/* pt-20 accounts for fixed header, pb-16 for fixed footer */}
                {renderMobileContent()}
            </main>

            {/* Desktop Main Content Area (Shown only on large screens) */}
            <main className="hidden lg:block p-8">
                 <h2 className="text-3xl font-extrabold text-green-800 mb-6">Full Dashboard View</h2>
                 {/* Retaining the original multi-column desktop layout */}
                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-3 space-y-6">
                        <AccountSummary accountData={accountData} userId={userId} />
                        {/* Action Buttons below the Summary on Desktop */}
                        <ActionButtons 
                            db={db}
                            userId={userId}
                            isCardFrozen={accountData.isCardFrozen}
                        />
                    </div>

                    <TransferFunds {...commonProps} />
                    <DepositFunds {...commonProps} />
                    <WithdrawalFunds {...commonProps} />
                    
                    {/* Loan Card added to the desktop grid */}
                    <LoanFunds {...commonProps} /> 

                    <DashboardCard title="Transaction History" className="lg:col-span-3">
                        <TransactionHistory transactions={accountData.transactions} limit={10} />
                    </DashboardCard>
                 </div>
            </main>

            {/* Fixed Bottom Navigation for Mobile (Hidden on large screens) */}
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-2xl z-20 lg:hidden">
                <nav className="flex justify-around">
                    {TABS.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex flex-col items-center justify-center p-3 text-xs w-full transition-colors focus:outline-none ${
                                activeTab === tab.id
                                    // Updated active tab colors
                                    ? 'text-green-700 border-t-2 border-green-700 font-semibold bg-green-50'
                                    : 'text-gray-500 hover:text-green-600'
                            }`}
                        >
                            {tab.icon()}
                            <span className="mt-1">{tab.name}</span>
                        </button>
                    ))}
                </nav>
            </div>
        </div>
    );
}
